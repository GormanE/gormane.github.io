<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		<script src="/includes/js/jquery-3.3.1.min.js"></script>
		<script src="/includes/js/jquery.terminal.min.js"></script>
		<script src="/includes/js/echo_newline.js"></script>
		<link rel="stylesheet" href="/includes/css/jquery.terminal.min.css"/>
		<link rel="icon" type="image/png" href="/includes/img/favicon.png">
		<title>ed</title>
		<script>
			var json_data;

			$.ajax({
				url: "/config.json",
				cache: false,
				async: false,
				// if request successful
				success:function(json) {
					json_data = json;
				}
				// if request failed
				}).fail(function() {
					alert("Error: Failed to retrieve config.json");
					window.stop();
				}
			);

			const file_system = json_data['directory'];
			var terminal;
			var start_directory = "ed";
			var curr_directory = file_system[start_directory]
			parent.setActiveTitle("Terminal - " + start_directory);

		</script>
	</head>
	<body>
		<script src="/includes/js/edos.js"></script>
		<script>
			terminal = $('body').terminal({
				// prints help message to the user
				help : function() {
					this.echo('Here is a list of the [[b;;]available commands]\n');

					// 		 		 command		description
					this.echo('[[b;;]cd] \t\t\t Change the [[b;#4545ff;]directory]');
					this.echo('[[b;;]clear] \t\t Clears the screen of all text');
					this.echo('[[b;;]exit] \t\t Closes the current tab')
					this.echo('[[b;;]ls] \t\t\t Displays files in current directory');
					this.echo('\t\t\t [[b;;]-l] \t Long listing format')
					this.echo('[[b;;]print] \t\t Displays text, [[b;;;]txt files], [[b;#a6a600;]image files]');

					this.echo('\nYou can also [[b;;]tab complete] file names and\n[[b;;]run] [[b;green;]executables] by entering the file name\n');
				},
				// changes current directory to path (must be directory)
				cd : function(path) {
					// if path is root directory
					if (path == "/" || path == "\\"){
						curr_directory = path_exists(start_directory, file_system, false)
					}

					// if path exists
					if (path_exists(path, curr_directory, false)){
						// if file is directory
						if (path_exists(path, curr_directory, false)["_type"] == "dir"){

							// switch curr_directory to new directory
							curr_directory = path_exists(path, curr_directory, false);

							// if curr_directory is at root
							if (curr_directory["_parent"] == ""){
								this.set_prompt(curr_directory['_name'] + ">");
								parent.setActiveTitle("Terminal - " + curr_directory['_name']);
							}
							// else curr_directory is below root
							else{
								this.set_prompt(curr_directory['_parent'].replace(/\//g, "\\") + "\\" + curr_directory['_name'] + ">");
								parent.setActiveTitle("Terminal - " + curr_directory['_parent'] + "/" + curr_directory['_name']);
							}
						}
						// else not a directory
						else{
							this.echo("The directory name is invalid.");
						}
					}
					// else path does not exist
					else{
						this.echo("The system cannot find the path specified.");
					}

					this.echo();
				},
				// close the current tab (must have parent window)
				exit : function() {
					// if parent window exists
					if (self != top){
						parent.closeActive();
					}
				},
				// lists the files present in current directory (+ args)
				ls : function(...args) {
					// get arguments from command line
					var options = $.terminal.parse_options(args);

					// for each file in curr_directory
					for (field in curr_directory){

						// if field begins with _, ignore it
						if (field.startsWith("_")){
							continue;
						}

						var file = curr_directory[field];
						var output = "";

						// if l flag is true
						if (options.l){
							// add additional information
							output += file['_date'] + "\t" + file['_time'] + "\t";

							// if is directory, add <div> tag
							if (file["_type"] == "dir"){
								output += "&#60;dir&#62;\t\t";
							}
							else{
								output += "\t\t\t";
							}
						}

						// switch on type of file
						switch(file["_type"]){
							case "dir":
								output += "[[b;#4545ff;]" + file["_name"] + "]";
								break;
							case "pic":
								output += "[[b;#a6a600;]" + file["_name"] + "]";
								break;
							case "exe":
								output += "[[b;green;]" + file["_name"] + "]";
								break;
							case "html":
								output += "[[b;green;]" + file["_name"] + "]";
								break;
							case "txt":
								output += "[[b;;]" + file["_name"] + "]";
								break;
							default:
								output += "[[;;]" + file["_name"] + "]";
						}

						// if file type not in hidden list
						if (!file["_type"].match("html|data")) {
							this.echo(output);
						}
					}

					this.echo();
				},
				// displays the message of file passed
				print : function(msg) {
					// if msg is a path that exists and that type is txt
					if (path_exists(msg, curr_directory, true) && path_exists(msg, curr_directory, true)["_type"] == "txt"){
						// generate url of file path
						var url = path_to_url(curr_directory["_parent"] + "/" + curr_directory["_name"] + "/" + msg);

						// ajax request to get file
						$.ajax({
							url: url,
							cache: false,
							success:function(text) {
								// print file contents
								terminal.echo(text);
							}
							}).fail(function() {
								// print error message
								terminal.echo("No such file or directory.\n")
							}
						);
					}
					// else if image
					else if (path_exists(msg, curr_directory, true) && path_exists(msg, curr_directory, true)["_type"] == "pic"){
						// generate url of file path
						var url = path_to_url(curr_directory["_parent"] + "/" + curr_directory["_name"] + "/" + msg);

						// print image
						this.echo("<img style='width: 50%;' src=\"" + url + "\"/>", {raw: true});
						this.echo();
					}
					// else print passed msg
					else{
						switch(msg){
							// general kenobi easter egg
							case 'hello there':
								this.echo('general kenobi');
								break;
							// default behaviour prints message
							default:
								this.echo(msg);
						}
						this.echo();
					}
				}
			}, {
				name : 'edgorman.github.io terminal',
				keymap : {
						'CTRL+R': function(e, original) {
								 location.reload();
						}
				},
				doubleTab : function(){

				},
				completion : function(string){
					// get command atttributes
					var cmd = $.terminal.parse_command(this.before_cursor());
					var path = "";

					// if command 'rest' is empty
					if (cmd.rest == ""){
						path = cmd.name;
					}
					else {
						path = cmd.rest;
					}

					var segments = path.split(/[\\/]/);
					var tmp_directory = null;

					// if tab in current directory
					if (segments.length == 1){
						tmp_directory = curr_directory;
					}
					else{
						path = segments.slice(0, segments.length-1).join('/');
						tmp_directory = path_exists(path, curr_directory, false);
					}

					var entry = "";
					var commands=[];

					// add files to completion list
					for (field in tmp_directory){
						// if field begins with _
						if (field.startsWith("_")){
							continue;
						}
						else{
							if (segments.length == 1){
								entry = tmp_directory[field]["_name"];
							}
							else{
								entry = path + "/" + tmp_directory[field]["_name"];
							}
							commands.push(entry);
						}
					}
					return commands;
				},
				onCommandNotFound : function(command, terminal){
					var path = command;

					// if path + ".txt" exists
					if (path_exists(path+".txt", curr_directory, true)){
						path += ".txt";

						// if type of file is an executable
						if (path_exists(path, curr_directory, true)["_type"] == "exe"){
							// generate url of file path
							var url = path_to_url(curr_directory["_parent"] + "/" + curr_directory["_name"] + "/" + path);

							// ajax request to get file
							$.ajax({
								url: url,
								cache: false,
								success:function(text) {
									var textLines = text.split("\n");
									var result = {};
									var i = 0;

									// for each line in file
									var question_loop = function(textLines){
										// extract instructions
										var command = textLines[i].split("~")[0];
										var name = textLines[i].split("~")[1];
										var message = textLines[i].split("~")[2];
										var format = textLines[i].split("~")[3];

										// switch on type of command
										switch(command){
											case 'echo':
												// print message
												terminal.echo("[[b;;]"+message+"]");
												i++;

												// if questions left, loop
												if (i < textLines.length-1){
													question_loop(textLines);
												}
												break;
											case 'prompt':
												// asks question and returns to anon function when complete
												ask_question("[[b;;]"+message+"]", format, function(res){
													i++;
													result[name] = res;

													// if questions left, loop
													if (i < textLines.length-1){
														question_loop(textLines);
													}
												});
												break;
											case 'confirm':
												// asks question and returns to anon function when complete
												ask_question("[[b;;]"+message+"]", format, function(res){
													i++;
													result[name] = res;

													// if questions left, loop
													if (i < textLines.length-1){
														question_loop(textLines);
													}
												});
												break;
											case 'execute':
												// switch on type of execute
												switch (name) {
													case 'email':
														// if user has confirmed to send
														if (result["confirm"] == "y"){
															// ajax request to post email
															$.ajax({
																url: "https://usebasin.com/f/441f945eb655.json",
																method: "POST",
																data: {message: result["message"], email: result["email"]},
																dataType: "json",
																success: function(){
																	alert("Email sent successfully.");
																}
															}).fail(function() {
																alert("Error: Email not sent.");
															});
													  }
														terminal.echo();
													  break;
												  case 'redirect':
												 		// redirect user to url
														terminal.echo("Redirecting . . .\n");
		 												window.open(message);
		 												break;
		 										  case 'tab':
														// open new tab for user
														terminal.echo("Redirecting . . .\n");
		 										 		parent.newTab(message);
		 												parent.setActiveTitle("Post Viewer - " + message.substring(1, message.length));
		 												break;
		 											default:
														console.log("Error - Executable command not recognised: " + name);
												}
												break;
											default:
												console.log("Error - Command not recognised: " + command);
										}

									}

									// call question loop
									terminal.echo();
									question_loop(textLines);
								}
								// if request fails
							}).fail(function() {
								terminal.echo("[[;red;]Error: Command not found '" + command + "'\n");
							});

						}
						else{
							terminal.echo("[[;red;]Error: Command not found '" + command + "'\n");
						}
					}
					else{
						this.echo("[[;red;]Error: Command not found '" + command + "'\n");
					}
				},
				exceptionHandler : function(exception){
					alert(exception);
				},
				mobileDelete : true,
				checkArity : false,
				prompt : start_directory + ">",
				greetings : 'Copyright (c) 2020 Edward Gorman\n<https://github.com/edgorman>\n\nTo start enter the command [[b;;]"help"]\n'
			});
		</script>
	</body>
</html>
