<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		<script src="/includes/js/jquery-3.3.1.min.js"></script>
		<script src="/includes/js/bootstrap.min.js"></script>
		<link rel="stylesheet" type="text/css" href="/includes/css/bootstrap.min.css"/>
		<link rel="stylesheet" type="text/css" href="/includes/css/edos.css"/>
		<link rel="icon" type="image/png" href="/includes/img/favicon.png"/>
		<script src="https://kit.fontawesome.com/8344083c6b.js" crossorigin="anonymous"></script>
		<title>ed</title>
		<script>
			var json_data;

			$.ajax({
				url: "/config.json",
				cache: false,
				async: false,
				// if request successful
				success:function(json) {
					json_data = json;
				}
				// if request failed
				}).fail(function() {
					alert("Error: Failed to retrieve config.json");
					parent.closeActive();
				}
			);

			const file_system = json_data['directory'];
			var start_directory = "ed";
			var curr_directory = file_system[start_directory]
			parent.setActiveTitle("File Explorer - " + start_directory);
		</script>
  </head>
  <body class="newtab">
		<script src="/includes/js/edos.js"></script>
		<div class="container-fluid h-100 w-100 d-flex flex-column">
			<div class="row justify-content-center">
				<div class="search-bar input-group input-group-sm mt-3 mb-3">
					<div class="input-group-prepend">
						<button class="btn btn-outline-secondary" type="button" onclick="changeDirectory('ed/')">
							<i class="fas fa-level-up-alt"></i>
						</button>
  				</div>
				  <input id="search" type="text" class="form-control text-light" placeholder="Search for File" aria-label="Search for file name" value="ed/">
				  <div class="input-group-append">
				    <button class="btn btn-outline-secondary" type="button" onclick="changeDirectory($('#search').val());">
							<i class="fas fa-search"></i>
						</button>
				  </div>
				</div>
			</div>
			<div class="explorer row flex-grow-1 mt-3 mb-3">

			</div>
		</div>
		<script>
			document.getElementById('search').addEventListener('keyup', ({key}) => {
				if (key === "Enter") changeDirectory($('#search').val());
			})

			function loadDirectory(){
				// for each file in curr_directory
				for (field in curr_directory){

					// if field begins with _, ignore it
					if (field.startsWith("_")){
						continue;
					}

					var file = curr_directory[field];
					var url = curr_directory["_parent"] + "/" + curr_directory["_name"] + "/" + file["_name"];
					var output = "<div class=\"col-lg-2 col-md-3 col-sm-4 col-6 d-flex justify-content-center tab-icon\">";

					// switch on type of file
					switch(file["_type"]){
						case "dir":
							output += "<div class=\"folder\" style=\"height: 120px; width: 100px;\" onclick=\"changeDirectory('" + url + "');\"><span>" + file["_name"] + "</span></div>";
							break;
						case "pic":
							output += "<div class=\"file\" style=\"height: 120px; width: 100px;\" onclick=\"parent.newTab('" + url.replace('ed/', '') + "'); parent.setActiveTitle('" + url + "'); parent.setActiveBackground('white');\"><span>" + file["_name"] + "</span></div>";
							break;
						case "exe":
							output += "<div class=\"cli\" style=\"height: 120px; width: 100px;\" onclick=\"runExecutable('" + file["_name"] + "')\"><span>" + file["_name"] + "</span></div>";
							break;
						case "html":
							output += "<div class=\"file\" style=\"height: 120px; width: 100px;\"><span>" + file["_name"] + "</span></div>";
							break;
						case "txt":
							output += "<div class=\"file\" style=\"height: 120px; width: 100px;\" onclick=\"parent.newTab('" + url.replace('ed/', '') + "'); parent.setActiveTitle('" + url + "'); parent.setActiveBackground('white');\"><span>" + file["_name"] + "</span></div>";
							break;
						default:
							output += "<div class=\"file\" style=\"height: 120px; width: 100px;\" onclick=\"parent.newTab('" + url.replace('ed/', '') + "'); parent.setActiveTitle('" + url + "'); parent.setActiveBackground('white');\"><span>" + file["_name"] + "</span></div>";
					}

					// if file type not in hidden list
					if (!file["_type"].match("html|data") && !(file["_name"] == "." || file["_name"] == "..")) {
						output += "</div>";
						$('.explorer').append(output);
					}

				}
			}

			function changeDirectory(path){
				// if path is root directory
				if (path == "/" || path == "\\" || path == "ed" || path == "ed/"){
					curr_directory = path_exists(start_directory, file_system, false)
				}

				// if path exists
				if (path_exists(path, file_system, false)){
					// if file is directory
					if (path_exists(path, file_system, false)["_type"] == "dir"){

						// switch curr_directory to new directory
						curr_directory = path_exists(path, file_system, false);

						// if curr_directory is at root
						if (curr_directory["_parent"] == ""){
							parent.setActiveTitle("File Explorer - " + curr_directory['_name']);
							$('.search-bar input').val(curr_directory['_name']);
							$('.search-bar button:eq(0)').attr("onclick", "changeDirectory('" + start_directory + "/')");
						}
						// else curr_directory is below root
						else{
							parent.setActiveTitle("File Explorer - " + curr_directory['_parent'] + "/" + curr_directory['_name']);
							$('.search-bar input').val(curr_directory['_parent'] + "/" + curr_directory['_name']);
							$('.search-bar button:eq(0)').attr("onclick", "changeDirectory('" + curr_directory["_parent"] + "')");
						}
					}
					// else not a directory
					else{
						parent.spawnToast("Error", "The directory name is invalid.")
					}
				}
				// else path does not exist
				else{
					parent.spawnToast("Error", "The system cannot find the path specified.")
				}

				clearDirectory();
				loadDirectory();
			}

			function clearDirectory(){
				$('.explorer').html('');
			}

			function runExecutable(path){
				var url = path_to_url(curr_directory["_parent"] + "/" + curr_directory["_name"] + "/" + path + ".txt");

				// ajax request to get file
				$.ajax({
					url: url,
					cache: false,
					success:function(text) {
						var textLines = text.split("\n");
						var result = {};
						var i = 0;

						// for each line in file
						var question_loop = function(textLines){
							// extract instructions
							var command = textLines[i].split("~")[0];
							var name = textLines[i].split("~")[1];
							var message = textLines[i].split("~")[2];
							var format = textLines[i].split("~")[3];

							// switch on type of command
							switch(command){
								case 'echo':
									// print message
									alert(message);
									i++;

									// if questions left, loop
									if (i < textLines.length-1){
										question_loop(textLines);
									}
									break;
								case 'prompt':
									// prompt question
									var res = "";
									while (!(new RegExp(format).test(res))){
										res = prompt(message);
										if(res == null){
											return;
										}
									}
									result[name] = res;
									i++;

									// if questions left, loop
									if (i < textLines.length-1){
										question_loop(textLines);
									}
									break;
								case 'confirm':
									// prompt question
									result[name] = confirm(message);
									i++;

									// if questions left, loop
									if (i < textLines.length-1){
										question_loop(textLines);
									}
									break;
								case 'execute':
									// switch on type of execute
									switch (name) {
										case 'email':
											// if user has confirmed to send
											if (result["confirm"] == true){

												// ajax request to post email
												$.ajax({
													url: "https://usebasin.com/f/441f945eb655.json",
													method: "POST",
													data: {message: result["message"], email: result["email"]},
													dataType: "json",
													success: function(){
														alert("Email sent successfully.");
													}
												}).fail(function() {
													alert("Error: Email not sent.");
												});
											}
											break;
										case 'redirect':
											// redirect user to url
											window.open(message);
											break;
										case 'tab':
											// open new tab for user
											parent.newTab(message);
											parent.setActiveTitle("Post Viewer - " + message.substring(1, message.length));
											break;
										default:
											console.log("Error - Executable command not recognised: " + name);
									}
									break;
								default:
									console.log("Error - Command not recognised: " + command);
							}

						}

						// call question loop
						question_loop(textLines);
					}
					// if request fails
				}).fail(function() {
					parent.spawnToast("Error", "No such file or directory.\n");
				});
			}

			loadDirectory();
		</script>
  </body>
</html>
