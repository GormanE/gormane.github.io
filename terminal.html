<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		<script src="includes/js/jquery-3.3.1.min.js"></script>
		<script src="includes/js/jquery.terminal.min.js"></script>
		<script src="includes/js/echo_newline.js"></script>
		<link rel="stylesheet" href="includes/css/jquery.terminal.min.css"/>
		<link rel="icon" type="image/png" href="includes/img/favicon.png">
		<title>ed</title>
		<script>
			var json_data;

			$.ajax({
				url: "config.json",
				cache: false,
				async: false,
				// if request successful
				success:function(json) {
					json_data = json;
				}
				// if request failed
				}).fail(function() {
					alert("Error: Failed to retrieve config.json");
					window.stop();
				}
			);


			const file_system = json_data['directory'];
			var terminal;
			var start_directory = "ed";
			var curr_directory = file_system[start_directory]
			parent.setActiveTitle("Terminal - " + start_directory);

			function path_exists(path, from_dir, file_flag){
				if (path == undefined){
					return false;
				}

				let segments = path.split(/[\\/]/);
				let temp_directory = from_dir;

				// for each segment
				for (let i=0; i < segments.length; i++){
					var seg = segments[i];

					if (seg == "" || seg == "."){									// self
						continue;
					}
					else if (seg == '..'){												// parent dir
						if (temp_directory["_parent"] != ""){
							temp_directory = path_exists(temp_directory["_parent"], file_system, file_flag);
						}
					}
					else if (temp_directory[seg] != null){				// child
						if (temp_directory[seg]["_type"] == "dir" || file_flag){
							temp_directory = temp_directory[seg];
						}
						else{
							return false;
						}
					}
					else{																					// n/a
						return false;
					}
				}
				return temp_directory;
			}

			function ask_question(question, format, callback){
				terminal.push(function(input){
					if (new RegExp(format).test(input)){
						terminal.pop();
						callback(input);
					}
				}, {
            prompt: question + ' '
        });
			}

			function send_email(result){
				if (result["confirm"] == "y"){
					$.ajax({
					  url: "https://usebasin.com/f/441f945eb655.json",
					  method: "POST",
					  data: {message: result["message"], email: result["email"]},
					  dataType: "json",
						success: function(){
							alert("Email sent successfully.");
						}
					}).fail(function() {
						alert("Error: Email not sent.")
					});
				}
		  }
		</script>
	</head>
	<body>
		<script>
			terminal = $('body').terminal({
				help : function() {
					this.echo('Here is a list of the [[b;;]available commands]\n');

					// 		 		 command		description
					this.echo('[[b;;]cd] \t\t\t Change the directory');
					this.echo('[[b;;]clear] \t\t Clears the screen of all text');
					this.echo('[[b;;]exit] \t\t Reloads the terminal')
					this.echo('[[b;;]ls] \t\t\t Displays files in directory');
					this.echo('\t\t\t [[b;;]-l] \t Long listing format')
					this.echo('[[b;;]print] \t\t Displays text (string or file)');
					this.echo('[[b;;]run] \t\t Executes a file (.exe or .html)');

					this.echo('\nYou can also [[b;;]tab complete] file names\n')
				},
				cd : function(path) {
					if (path == "/" || path == "\\"){
						curr_directory = path_exists(start_directory, file_system, false)
					}
					if (path_exists(path, curr_directory, false)){
						if (path_exists(path, curr_directory, false)["_type"] == "dir"){
							curr_directory = path_exists(path, curr_directory, false);
							if (curr_directory["_parent"] == ""){
								this.set_prompt(curr_directory['_name'] + ">");
								parent.setActiveTitle("Terminal - " + curr_directory['_name']);
							}
							else{
								this.set_prompt(curr_directory['_parent'].replace(/\//g, "\\") + "\\" + curr_directory['_name'] + ">");
								parent.setActiveTitle("Terminal - " + curr_directory['_parent'] + "/" + curr_directory['_name']);
							}
						}
						else{
							this.echo("The directory name is invalid.");
						}
					}
					else{
						this.echo("The system cannot find the path specified.");
					}
					this.echo();
				},
				exit : function() {
					parent.closeActive();
				},
				ls : function(...args) {
					var options = $.terminal.parse_options(args);

					// for each file in the directory
					for (field in curr_directory){

						// if field begins with _
						if (field.startsWith("_")){
							continue;
						}

						var file = curr_directory[field];
						var output = "";

						// if l flag is true
						if (options.l){
							output += file['_date'] + "\t" + file['_time'] + "\t";
							if (file["_type"] == "dir"){
								output += "&#60;dir&#62;\t\t";
							}
							else{
								output += "\t\t\t";
							}
						}

						// switch on type of file
						switch(file["_type"]){
							case "dir":
								output += "[[b;#4545ff;]" + file["_name"] + "]";
								break;
							case "pic":
								output += "[[b;#a6a600;]" + file["_name"] + "]";
								break;
							case "exe":
								output += "[[b;green;]" + file["_name"] + "]";
								break;
							case "html":
								output += "[[b;green;]" + file["_name"] + "]";
								break;
							case "txt":
								output += "[[b;;]" + file["_name"] + "]";
								break;
							default:
								output += "[[;;]" + file["_name"] + "]";
						}

						this.echo(output);
					}
					this.echo();
				},
				print : function(msg) {
					// if is text
					if (path_exists(msg, curr_directory, true) && path_exists(msg, curr_directory, true)["_type"] == "txt"){
						var url = curr_directory["_parent"] + "/" + curr_directory["_name"] + "/" + msg;
						if (url.startsWith("/ed/")){
							url = url.substring(4);
						}
						else if (url.startsWith("ed/")){
							url = url.substring(3);
						}
						// ajax request to get file
						$.ajax({
							url: url,
							cache: false,
							// if request successful
							success:function(text) {
								 terminal.echo(text);
							}
							// if request failed
							}).fail(function() {
								terminal.echo("No such file or directory.\n")
							}
						);
					}
					// else if image
					else if (path_exists(msg, curr_directory, true) && path_exists(msg, curr_directory, true)["_type"] == "pic"){
						var url = curr_directory["_parent"] + "/" + curr_directory["_name"] + "/" + msg;
						if (url.startsWith("/ed/")){
							url = url.substring(4);
						}
						else if (url.startsWith("ed/")){
							url = url.substring(3);
						}

						this.echo("<img style='width: 50%;' src=\"" + url + "\"/>\n", {raw: true});
					}
					// else is normal message
					else{
						if (msg == "hello there"){
							this.echo("general kenobi\n");
						}
						else{
							this.echo(msg + "\n");
						}
					}
				},
				run : function(path) {
					// check path exists
					if (path_exists(path, curr_directory, true)){
						if (path_exists(path, curr_directory, true)["_type"] == "html"){
							var url = curr_directory["_parent"] + "/" + curr_directory["_name"] + "/" + path;
							if (url.startsWith("/ed/")){
								url = url.substring(4);
							}
							else if (url.startsWith("ed/")){
								url = url.substring(3);
							}

							window.open(url);
							this.echo();
						}
					}
					else if (path_exists(path+".txt", curr_directory, true)){
						path += ".txt";
						if (path_exists(path, curr_directory, true)["_type"] == "exe"){

							var url = curr_directory["_parent"] + "/" + curr_directory["_name"] + "/" + path;
							if (url.startsWith("/ed/")){
								url = url.substring(4);
							}
							else if (url.startsWith("ed/")){
								url = url.substring(3);
							}
							// ajax request to get file
							$.ajax({
								url: url,
								cache: false,
								// if request successful
								success:function(text) {
									// commit each command per line
									var textLines = text.split("\n");
									var result = {};
									var i = 0;

									var question_loop = function(textLines){
										// extract instructions
										var command = textLines[i].split("~")[0];
										var name = textLines[i].split("~")[1];
										var message = textLines[i].split("~")[2];
										var format = textLines[i].split("~")[3];

										// echo command
										if (command == 'echo'){
											terminal.echo(message);
											i++;

											// if questions left, loop
											if (i < textLines.length-1){
												question_loop(textLines);
											}
										}
										// prompt command
										else if (command == 'prompt'){
											// asks question and returns to anon function when complete
											ask_question(message, format, function(res){
												i++;
												result[name] = res;

												// if questions left, loop
												if (i < textLines.length-1){
													question_loop(textLines);
												}
											});
										}
										// execute commands
										else if (command == 'execute'){
											// preset commands
											switch (name) {
											 case 'email':
											 	 if (result["confirm"] == "y"){
													 $.ajax({
													 	 url: "https://usebasin.com/f/441f945eb655.json",
														 method: "POST",
														 data: {message: result["message"], email: result["email"]},
														 dataType: "json",
														 success: function(){
															 alert("Email sent successfully.");
														 }
													 }).fail(function() {
														 alert("Error: Email not sent.")
													 });
												 }
												 break;
											 case 'redirect':
											 	 window.open(message);
											 default:
											}
										}
									}

									// call question loop
									question_loop(textLines);
								}
								// if request fails
							}).fail(function() {
								terminal.echo("No such file or directory.\n");
							});

						}
						else{
							this.echo("File is not an executable.\n");
						}
					}
					else{
						this.echo("No such file or directory.\n");
					}
				}
			}, {
				name : 'edgorman.github.io terminal',
				keymap : {
						'CTRL+R': function(e, original) {
								 location.reload();
						}
				},
				completion : function(){
					var commands=[];
					// var commands = ["cat", "cd", "clear", "echo", "ls", "help"];
					for (field in curr_directory){
						// if field begins with _
						if (field.startsWith("_")){
							continue;
						}
						else{
							commands.push(curr_directory[field]["_name"]);
						}
					}
					return commands;
				},
				exceptionHandler : function(exception){
					alert(exception);
				},
				mobileDelete : true,
				checkArity : false,
				prompt : start_directory + ">",
				greetings : 'Copyright (c) 2020 Edward Gorman\n<https://github.com/edgorman>\n\nTo start enter the command [[b;;]"help"]\n'
			});
		</script>
	</body>
</html>
